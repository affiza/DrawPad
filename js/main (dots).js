
var canvas = [[{"x":200,"y":274,"t":1297010763017},{"x":201,"y":278,"t":1297010763086},{"x":203,"y":284,"t":1297010763107},{"x":207,"y":292,"t":1297010763118},{"x":213,"y":302,"t":1297010763134},{"x":218,"y":311,"t":1297010763151},{"x":222,"y":319,"t":1297010763163},{"x":226,"y":326,"t":1297010763182},{"x":230,"y":332,"t":1297010763210},{"x":232,"y":337,"t":1297010763211},{"x":235,"y":342,"t":1297010763229},{"x":236,"y":344,"t":1297010763244},{"x":238,"y":346,"t":1297010763267},{"x":239,"y":347,"t":1297010763274},{"x":240,"y":347,"t":1297010763292},{"x":241,"y":347,"t":1297010763308},{"x":243,"y":342,"t":1297010763338},{"x":245,"y":334,"t":1297010763356},{"x":250,"y":324,"t":1297010763372},{"x":253,"y":313,"t":1297010763390},{"x":256,"y":300,"t":1297010763410},{"x":260,"y":288,"t":1297010763420},{"x":260,"y":278,"t":1297010763434},{"x":262,"y":270,"t":1297010763461},{"x":263,"y":265,"t":1297010763474},{"x":265,"y":263,"t":1297010763486},{"x":268,"y":263,"t":1297010763502}],[{"x":324,"y":294,"t":1297010763742},{"x":326,"y":297,"t":1297010763819},{"x":331,"y":297,"t":1297010763841},{"x":338,"y":295,"t":1297010763854},{"x":347,"y":290,"t":1297010763867},{"x":353,"y":283,"t":1297010763883},{"x":357,"y":277,"t":1297010763909},{"x":359,"y":271,"t":1297010763916},{"x":359,"y":264,"t":1297010763933},{"x":354,"y":260,"t":1297010763946},{"x":346,"y":260,"t":1297010763967},{"x":335,"y":264,"t":1297010763979},{"x":327,"y":273,"t":1297010763994},{"x":320,"y":285,"t":1297010764016},{"x":315,"y":299,"t":1297010764028},{"x":314,"y":310,"t":1297010764042},{"x":314,"y":323,"t":1297010764058},{"x":315,"y":330,"t":1297010764079},{"x":319,"y":337,"t":1297010764090},{"x":326,"y":340,"t":1297010764106},{"x":334,"y":341,"t":1297010764125},{"x":345,"y":339,"t":1297010764141},{"x":357,"y":332,"t":1297010764154},{"x":368,"y":322,"t":1297010764170},{"x":379,"y":313,"t":1297010764186}],[{"x":419,"y":273,"t":1297010764350},{"x":405,"y":269,"t":1297010764395},{"x":400,"y":269,"t":1297010764412},{"x":393,"y":271,"t":1297010764426},{"x":387,"y":276,"t":1297010764451},{"x":382,"y":284,"t":1297010764458},{"x":377,"y":293,"t":1297010764475},{"x":376,"y":302,"t":1297010764492},{"x":376,"y":310,"t":1297010764508},{"x":377,"y":319,"t":1297010764529},{"x":381,"y":324,"t":1297010764538},{"x":388,"y":328,"t":1297010764554},{"x":397,"y":328,"t":1297010764570},{"x":405,"y":328,"t":1297010764595},{"x":413,"y":323,"t":1297010764602},{"x":417,"y":316,"t":1297010764620},{"x":420,"y":307,"t":1297010764636},{"x":420,"y":297,"t":1297010764663},{"x":420,"y":289,"t":1297010764669},{"x":420,"y":285,"t":1297010764686},{"x":420,"y":281,"t":1297010764702},{"x":418,"y":280,"t":1297010764719},{"x":416,"y":280,"t":1297010764737},{"x":414,"y":283,"t":1297010764746},{"x":412,"y":291,"t":1297010764767},{"x":410,"y":300,"t":1297010764779},{"x":407,"y":314,"t":1297010764794},{"x":404,"y":331,"t":1297010764809},{"x":400,"y":349,"t":1297010764830},{"x":394,"y":366,"t":1297010764842},{"x":387,"y":383,"t":1297010764859},{"x":381,"y":397,"t":1297010764875},{"x":374,"y":406,"t":1297010764892},{"x":369,"y":411,"t":1297010764911},{"x":364,"y":414,"t":1297010764921},{"x":359,"y":414,"t":1297010764938},{"x":354,"y":411,"t":1297010764954},{"x":350,"y":402,"t":1297010764975},{"x":347,"y":396,"t":1297010764992}],[{"x":469,"y":294,"t":1297010765229},{"x":464,"y":289,"t":1297010765307},{"x":473,"y":288,"t":1297010765328},{"x":483,"y":283,"t":1297010765337},{"x":490,"y":279,"t":1297010765353},{"x":495,"y":276,"t":1297010765370},{"x":497,"y":272,"t":1297010765393},{"x":498,"y":267,"t":1297010765408},{"x":495,"y":262,"t":1297010765418},{"x":486,"y":258,"t":1297010765436},{"x":478,"y":256,"t":1297010765452},{"x":467,"y":256,"t":1297010765469},{"x":458,"y":261,"t":1297010765488},{"x":451,"y":270,"t":1297010765500},{"x":447,"y":282,"t":1297010765518},{"x":445,"y":295,"t":1297010765536},{"x":445,"y":307,"t":1297010765545},{"x":447,"y":317,"t":1297010765566},{"x":451,"y":323,"t":1297010765579},{"x":457,"y":330,"t":1297010765593},{"x":464,"y":333,"t":1297010765611},{"x":472,"y":335,"t":1297010765634},{"x":480,"y":335,"t":1297010765641},{"x":489,"y":335,"t":1297010765659},{"x":499,"y":327,"t":1297010765675}],[{"x":537,"y":227,"t":1297010765853},{"x":534,"y":242,"t":1297010765899},{"x":533,"y":260,"t":1297010765916},{"x":530,"y":281,"t":1297010765940},{"x":527,"y":303,"t":1297010765945},{"x":525,"y":322,"t":1297010765961},{"x":523,"y":334,"t":1297010765979},{"x":523,"y":340,"t":1297010766001},{"x":523,"y":342,"t":1297010766009},{"x":524,"y":340,"t":1297010766027},{"x":527,"y":328,"t":1297010766049}],[{"x":501,"y":262,"t":1297010766205},{"x":504,"y":261,"t":1297010766250},{"x":514,"y":261,"t":1297010766266},{"x":527,"y":262,"t":1297010766291},{"x":542,"y":263,"t":1297010766300},{"x":556,"y":263,"t":1297010766316},{"x":565,"y":263,"t":1297010766330}],[{"x":616,"y":272,"t":1297010766541},{"x":605,"y":267,"t":1297010766588},{"x":597,"y":267,"t":1297010766605},{"x":587,"y":269,"t":1297010766617},{"x":576,"y":274,"t":1297010766636},{"x":565,"y":283,"t":1297010766651},{"x":557,"y":291,"t":1297010766669},{"x":551,"y":299,"t":1297010766687},{"x":548,"y":306,"t":1297010766704},{"x":548,"y":312,"t":1297010766716},{"x":549,"y":318,"t":1297010766735},{"x":555,"y":323,"t":1297010766746},{"x":562,"y":325,"t":1297010766763},{"x":571,"y":325,"t":1297010766777},{"x":580,"y":325,"t":1297010766795},{"x":588,"y":319,"t":1297010766811},{"x":593,"y":309,"t":1297010766825},{"x":599,"y":294,"t":1297010766843},{"x":601,"y":284,"t":1297010766859},{"x":604,"y":273,"t":1297010766875},{"x":605,"y":266,"t":1297010766895},{"x":605,"y":262,"t":1297010766905},{"x":606,"y":260,"t":1297010766921},{"x":606,"y":262,"t":1297010766955},{"x":606,"y":271,"t":1297010766972},{"x":606,"y":283,"t":1297010766986},{"x":606,"y":298,"t":1297010767001},{"x":606,"y":313,"t":1297010767019},{"x":605,"y":326,"t":1297010767037},{"x":605,"y":334,"t":1297010767055},{"x":605,"y":339,"t":1297010767068},{"x":605,"y":342,"t":1297010767084},{"x":610,"y":342,"t":1297010767098},{"x":617,"y":339,"t":1297010767118}],[{"x":660,"y":180,"t":1297010767324},{"x":654,"y":186,"t":1297010767354},{"x":650,"y":198,"t":1297010767370},{"x":647,"y":218,"t":1297010767385},{"x":645,"y":242,"t":1297010767401},{"x":644,"y":267,"t":1297010767420},{"x":644,"y":290,"t":1297010767434},{"x":645,"y":309,"t":1297010767452},{"x":646,"y":323,"t":1297010767468},{"x":648,"y":332,"t":1297010767487},{"x":650,"y":338,"t":1297010767500},{"x":653,"y":342,"t":1297010767517},{"x":656,"y":344,"t":1297010767536},{"x":662,"y":343,"t":1297010767545},{"x":668,"y":334,"t":1297010767566},{"x":673,"y":318,"t":1297010767578},{"x":678,"y":299,"t":1297010767594},{"x":681,"y":288,"t":1297010767610},{"x":683,"y":281,"t":1297010767628},{"x":684,"y":277,"t":1297010767640},{"x":685,"y":276,"t":1297010767659},{"x":686,"y":275,"t":1297010767675},{"x":688,"y":276,"t":1297010767692},{"x":693,"y":280,"t":1297010767711},{"x":698,"y":283,"t":1297010767721},{"x":706,"y":283,"t":1297010767737}],[{"x":751,"y":198,"t":1297010767917},{"x":745,"y":216,"t":1297010767946},{"x":742,"y":230,"t":1297010767963},{"x":738,"y":250,"t":1297010767976},{"x":733,"y":269,"t":1297010767996},{"x":728,"y":288,"t":1297010768009},{"x":724,"y":303,"t":1297010768026},{"x":722,"y":313,"t":1297010768041},{"x":721,"y":321,"t":1297010768059},{"x":721,"y":326,"t":1297010768079},{"x":722,"y":331,"t":1297010768089},{"x":726,"y":332,"t":1297010768105}],[{"x":766,"y":302,"t":1297010768236},{"x":762,"y":298,"t":1297010768330},{"x":768,"y":298,"t":1297010768346},{"x":778,"y":298,"t":1297010768362},{"x":789,"y":297,"t":1297010768376},{"x":799,"y":292,"t":1297010768396},{"x":806,"y":285,"t":1297010768408},{"x":813,"y":276,"t":1297010768426},{"x":815,"y":269,"t":1297010768441},{"x":815,"y":260,"t":1297010768458},{"x":814,"y":255,"t":1297010768478},{"x":809,"y":252,"t":1297010768489},{"x":801,"y":252,"t":1297010768504},{"x":791,"y":256,"t":1297010768520},{"x":783,"y":269,"t":1297010768542},{"x":779,"y":284,"t":1297010768558},{"x":775,"y":299,"t":1297010768569},{"x":773,"y":312,"t":1297010768586},{"x":772,"y":325,"t":1297010768602},{"x":772,"y":335,"t":1297010768618},{"x":772,"y":342,"t":1297010768639},{"x":775,"y":346,"t":1297010768651},{"x":785,"y":346,"t":1297010768669},{"x":800,"y":339,"t":1297010768688},{"x":812,"y":327,"t":1297010768696}],[{"x":887,"y":260,"t":1297010768860},{"x":877,"y":255,"t":1297010768922},{"x":869,"y":260,"t":1297010768941},{"x":859,"y":269,"t":1297010768952},{"x":851,"y":277,"t":1297010768969},{"x":843,"y":284,"t":1297010768985},{"x":839,"y":291,"t":1297010769004},{"x":838,"y":297,"t":1297010769021},{"x":838,"y":303,"t":1297010769034},{"x":839,"y":310,"t":1297010769052},{"x":844,"y":318,"t":1297010769075},{"x":848,"y":325,"t":1297010769083},{"x":850,"y":333,"t":1297010769096},{"x":852,"y":341,"t":1297010769118},{"x":852,"y":347,"t":1297010769142},{"x":852,"y":352,"t":1297010769144},{"x":847,"y":357,"t":1297010769160},{"x":839,"y":359,"t":1297010769176},{"x":829,"y":359,"t":1297010769196},{"x":820,"y":359,"t":1297010769208},{"x":811,"y":359,"t":1297010769226}]];

var MAX_LINE_WIDTH = 10;
var MIN_LINE_WIDTH = 2;
var MAX_VELOCITY = 10;
var MOVE_TIME = 15;
var MOVE_Z = 80;

var container;
var camera, scene, renderer;
var cameraPath = [];
var cameraPathStep = 0;

$(init);

function init() {

	container = document.createElement( 'div' );
	document.body.appendChild( container );

	camera = new THREE.Camera( 10, window.innerWidth / window.innerHeight, 0.01, 500 );
	camera.position.x = -40;
	camera.position.y = 20;
	camera.position.z = -500;
	camera.target.position.x = 53;
	camera.target.position.y = -36;
	camera.target.position.z = 0;

	scene = new THREE.Scene();
	
	var canvasStartTime = canvas[0][0].t;
	var canvasEndTime = canvas[0][canvas[0].length - 1].t;
	
	for (var i = 1; i < canvas.length; i++) {
		canvasEndTime = Math.max(canvasEndTime, canvas[i][canvas[i].length - 1].t);
	}

	var canvasTotalTime = canvasEndTime - canvasStartTime;

	for (var k = 0; k < canvas.length; k++) {
		var points = canvas[k];

		var startTime = points[0].t;
		var endTime = points[points.length - 1].t;
		var totalTime = endTime - startTime;
	
		var material = new THREE.ParticleCircleMaterial({color: 0xffffff, opacity: 0.8});
		var prevLineWidth = MAX_LINE_WIDTH;
	
		for (var i = 0; i < points.length; i++) {
			var pointDistance = 0;
			var lineWidth = prevLineWidth;
			
			if (i > 0) {
				pointDistance = Math.sqrt(Math.pow(points[i].x - points[i - 1].x, 2) + Math.pow(points[i].y - points[i - 1].y, 2));
				var lineWidth = Math.max(MIN_LINE_WIDTH, (MAX_VELOCITY - pointDistance) / MAX_VELOCITY * MAX_LINE_WIDTH);
	
				if (Math.abs(lineWidth - prevLineWidth) > 0.1) {
					lineWidth = prevLineWidth + (lineWidth - prevLineWidth) / Math.abs(lineWidth - prevLineWidth);
				}
			}
			
			for (var j = 0; j < lineWidth; j++) {
				particle = new THREE.Particle(material);
				particle.position.x = points[i].x / 10 + (Math.random() * -4 + 2) * lineWidth / MAX_LINE_WIDTH;
				particle.position.y = -points[i].y / 10 + (Math.random() * -4 + 2) * lineWidth / MAX_LINE_WIDTH;
				particle.position.z = (points[i].t - canvasStartTime) / canvasTotalTime * MOVE_Z + (Math.random() * -4 + 2) * lineWidth / MAX_LINE_WIDTH;
				particle.scale.x = particle.scale.y = Math.random() * 0.5;
				
				setTimeout(function(particle) {
					return function() {
						scene.addObject(particle);
					}
				}(particle), (points[i].t - canvasStartTime) / canvasTotalTime * MOVE_TIME * 0.67 * 1000 + Math.random() * 40);
//				}(particle), 1);
			}
	
			particle = new THREE.Particle(material);
			particle.position.x = points[i].x / 10 + (Math.random() * -4 + 2) * lineWidth / MAX_LINE_WIDTH;
			particle.position.y = -points[i].y / 10 + (Math.random() * -4 + 2) * lineWidth / MAX_LINE_WIDTH;
			particle.position.z = (points[i].t - canvasStartTime) / canvasTotalTime * MOVE_Z;
			particle.scale.x = particle.scale.y = Math.random() * 0.5;
			
			cameraPath.push({
				x: particle.position.x,
				y: particle.position.y,
				z: particle.position.z
			});
			
			setTimeout(function(particle) {
				return function() {
					scene.addObject(particle);
				}
			}(particle), (points[i].t - canvasStartTime) / canvasTotalTime * MOVE_TIME * 0.67 * 1000);
//			}(particle), 1);
	
			prevLineWidth = lineWidth;
		}
	}

	renderer = new THREE.CanvasRenderer();
	renderer.setSize(window.innerWidth, window.innerHeight);

	container.appendChild(renderer.domElement);

	setInterval(loop, 1000/60);


	JSTweener.addTween(camera.position, {
		  time: MOVE_TIME,
		  transition: 'easeOutSine',
		  x: 53,
		  y: -36,
		  z: 500
	});
	  
//	setTimeout(destroy, 7000);
	
}

function loop() {
/*
	camera.position.z = camera.position.z + 0.3;
	camera.position.x += 0.3 * (camera.position.x / -50);
	camera.position.y += 0.3 * (camera.position.y / -50);
*/
/*
	camera.position.x = cameraPath[cameraPathStep].x;
	camera.position.y = cameraPath[cameraPathStep].y;
	camera.position.z = cameraPath[cameraPathStep].z;
	camera.target.position.x = cameraPath[cameraPathStep - 1].x;
	camera.target.position.y = cameraPath[cameraPathStep - 1].y;
	camera.target.position.z = cameraPath[cameraPathStep - 1].z;
	
	cameraPathStep++;
*/

	renderer.render(scene, camera);
}

function destroy() {
	scene.objects.splice(0, 1);
	
	if (scene.objects.length > 0) {
		setTimeout(destroy, 5);
	}
}